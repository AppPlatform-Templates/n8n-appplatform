spec:
  name: n8n
  region: ams

  services:
    - name: n8n
      image:
        registry_type: GHCR
        registry: ghcr.io
        repository: n8n-io/n8n
        tag: "1.116.2"
      http_port: 5678
      instance_count: 1
      instance_size_slug: apps-s-1vcpu-1gb

      health_check:
        http_path: /healthz
        initial_delay_seconds: 60
        period_seconds: 10
        timeout_seconds: 3
        success_threshold: 1
        failure_threshold: 3

      envs:
        # Database Configuration (PostgreSQL)
        - key: DB_TYPE
          value: postgresdb
        - key: DB_POSTGRESDB_HOST
          value: ${n8n-db.HOSTNAME}
        - key: DB_POSTGRESDB_PORT
          value: ${n8n-db.PORT}
        - key: DB_POSTGRESDB_DATABASE
          value: ${n8n-db.DATABASE}
        - key: DB_POSTGRESDB_USER
          value: ${n8n-db.USERNAME}
        - key: DB_POSTGRESDB_PASSWORD
          value: ${n8n-db.PASSWORD}

        # n8n Configuration
        - key: N8N_HOST
          value: ${APP_URL}
        - key: N8N_PROTOCOL
          value: https
        - key: N8N_PORT
          value: "5678"
        - key: WEBHOOK_URL
          value: https://${APP_URL}/

        # Security - IMPORTANT: Change these values!
        - key: N8N_ENCRYPTION_KEY
          value: CHANGE_THIS_TO_RANDOM_STRING
          scope: RUN_TIME
          type: SECRET

        # User folder for n8n data
        - key: N8N_USER_FOLDER
          value: /home/node/.n8n

        # Disable telemetry in production
        - key: N8N_DIAGNOSTICS_ENABLED
          value: "false"

        # Timezone
        - key: GENERIC_TIMEZONE
          value: Europe/Amsterdam
        - key: TZ
          value: Europe/Amsterdam

        # Task Runners (disabled for simpler deployment)
        # For code execution sandboxing, see deploy-with-runners.template.yaml
        - key: N8N_RUNNERS_ENABLED
          value: "false"

        # ⚠️ PRODUCTION STORAGE: Configure Spaces for persistent file storage
        # App Platform uses ephemeral storage - files are lost on container restart
        #
        # REQUIRED for production if you:
        # - Handle file uploads/downloads in workflows
        # - Use custom community nodes
        # - Process binary data (images, PDFs, etc.)
        #
        # Setup: See PRODUCTION.md#persistent-storage-critical-for-production
        # Quick setup (5 min):
        #   1. doctl spaces create n8n-storage-ams3 --region ams3
        #   2. doctl spaces keys create n8n-storage-key
        #   3. Uncomment and configure variables below
        #
        # Cost: $5/month for 250GB + $0.02/GB thereafter
        #
        # - key: N8N_DEFAULT_BINARY_DATA_MODE
        #   value: filesystem
        # - key: AWS_ACCESS_KEY_ID
        #   value: YOUR_SPACES_ACCESS_KEY
        #   scope: RUN_TIME
        #   type: SECRET
        # - key: AWS_SECRET_ACCESS_KEY
        #   value: YOUR_SPACES_SECRET_KEY
        #   scope: RUN_TIME
        #   type: SECRET
        # - key: AWS_S3_BUCKET_NAME
        #   value: n8n-storage-ams3
        # - key: AWS_S3_ENDPOINT
        #   value: https://ams3.digitaloceanspaces.com
        # - key: AWS_S3_FORCE_PATH_STYLE
        #   value: "true"

  databases:
    - name: n8n-db
      engine: PG
      version: "17"
      production: false
      cluster_name: n8n-db
